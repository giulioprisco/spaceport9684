var MAX_INDICES=262144,TEX_SCALE=1/6;export class Terrain{constructor(e){var t=Math.floor(Math.sqrt(MAX_INDICES/6)),r=t,a=1/e.heightMapScale.x/t;this.cellSize=a,this.xCellCount=t,this.yCellCount=r,this.xSize=t*a,this.ySize=r*a,this.mesh=this.createMesh(e)}update(e,t){var r=Math.floor(e/this.cellSize),a=Math.floor(t/this.cellSize),i=r*this.cellSize,o=a*this.cellSize,f=this.mesh.material,s=f.uniforms.offset.value;s[0]=i,s[1]=o,(s=f.uniforms.uvOffset.value)[0]=a*TEX_SCALE,s[1]=r*TEX_SCALE}createMesh(e){var t=Math.floor(Math.sqrt(MAX_INDICES/6)),r=t,a=1/e.heightMapScale.x/t,i=e.textures;i.forEach((function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.anisotropy=9}));var o=e.heightMap;o.wrapS=o.wrapT=THREE.RepeatWrapping;var f=this.createVtxBuffers(a,t+1,r+1),s=this.createIdBuffer(t+1,r+1),h=new THREE.BufferGeometry;h.setAttribute("position",new THREE.BufferAttribute(f.position,3)),h.setAttribute("uv",new THREE.BufferAttribute(f.uv,2)),h.setIndex(new THREE.BufferAttribute(s,1));var l=e.heightMapScale,u=e.fragScript.replace("%%TRANSITION_LOW%%",e.transitionLow.toString()).replace("%%TRANSITION_HIGH%%",e.transitionHigh.toString()),n=new THREE.RawShaderMaterial({uniforms:{offset:{type:"2f",value:[0,0]},uvOffset:{type:"2f",value:[0,0]},map1:{type:"t",value:i[0]},map2:{type:"t",value:i[1]},heightMap:{type:"t",value:o},heightMapScale:{type:"3f",value:[l.x,l.y,l.z]},fogColor:{type:"3f",value:e.fogColor.toArray()},fogNear:{type:"f",value:1},fogFar:{type:"f",value:e.fogFar},grassFogFar:{type:"f",value:e.grassFogFar}},vertexShader:e.vertScript,fragmentShader:u}),p=new THREE.Mesh(h,n);return p.receiveShadow=!0,p.frustumCulled=!1,p}createVtxBuffers(e,t,r){var a,i,o,f,s,h,l=new Float32Array(t*r*3),u=new Float32Array(t*r*2),n=0,p=0;for(i=0;i<r;++i)for(f=(i-r/2)*e,s=i,a=0;a<t;++a)o=(a-t/2)*e,h=a,l[n++]=o,l[n++]=f,l[n++]=4*Math.cos(1*a)+4*Math.sin(1*i),u[p++]=s*TEX_SCALE,u[p++]=h*TEX_SCALE;return{position:l,uv:u}}createIdBuffer(e,t){var r,a=(e-1)*(t-1)*3*2;r=a<=65536?new Uint16Array(a):new Uint32Array(a);var i,o,f=e-1,s=t-1;for(o=0;o<s;++o)for(i=0;i<f;++i){var h=6*(o*f+i);r[h+0]=(o+0)*e+(i+0),r[h+1]=(o+0)*e+(i+1),r[h+2]=(o+1)*e+(i+1),r[h+3]=(o+1)*e+(i+1),r[h+4]=(o+1)*e+(i+0),r[h+5]=(o+0)*e+(i+0)}return r}}